<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blocking Code Detector</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: white;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .test-section {
            background: #1e293b;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #2563eb;
        }
        .button.success { background: #10b981; }
        .button.danger { background: #dc2626; }
        .button.warning { background: #f59e0b; }
        .log {
            background: #000;
            color: #00ff00;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success { background: #10b981; color: white; }
        .status.error { background: #dc2626; color: white; }
        .status.warning { background: #f59e0b; color: white; }
        .blocking-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc2626;
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
            display: none;
        }
    </style>
</head>
<body>
    <div class="blocking-indicator" id="blockingIndicator">
        ‚ö†Ô∏è BLOCKING CODE DETECTED
    </div>

    <div class="container">
        <h1>üîç Blocking Code Detector</h1>
        
        <div class="test-section">
            <h2>Performance Monitor</h2>
            <div id="performanceStatus">
                <div class="status success">‚úÖ Performance monitoring active</div>
            </div>
        </div>

        <div class="test-section">
            <h2>Actions</h2>
            <button class="button" onclick="testMainAppExecution()">Test Main App Execution</button>
            <button class="button" onclick="testInfiniteLoop()">Test Infinite Loop Detection</button>
            <button class="button" onclick="testBlockingCode()">Test Blocking Code</button>
            <button class="button success" onclick="enableDevBypass()">Enable Dev Bypass</button>
        </div>

        <div class="test-section">
            <h2>Execution Log</h2>
            <div id="executionLog" class="log"></div>
            <button class="button" onclick="clearLog()">Clear Log</button>
        </div>

        <div class="test-section">
            <h2>Performance Metrics</h2>
            <div id="performanceLog" class="log"></div>
        </div>
    </div>

    <script>
        let logEntries = [];
        let performanceEntries = [];
        let lastHeartbeat = Date.now();
        let heartbeatInterval;
        let performanceInterval;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] [${type.toUpperCase()}] ${message}`;
            logEntries.push(entry);
            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logDiv = document.getElementById('executionLog');
            logDiv.textContent = logEntries.slice(-100).join('\n');
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            logEntries = [];
            updateLogDisplay();
        }

        function updatePerformanceLog() {
            const perfDiv = document.getElementById('performanceLog');
            perfDiv.textContent = performanceEntries.slice(-50).join('\n');
            perfDiv.scrollTop = perfDiv.scrollHeight;
        }

        function addPerformanceEntry(message) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${message}`;
            performanceEntries.push(entry);
            updatePerformanceLog();
        }

        function startHeartbeat() {
            heartbeatInterval = setInterval(() => {
                const now = Date.now();
                const timeSinceLastHeartbeat = now - lastHeartbeat;
                
                if (timeSinceLastHeartbeat > 1000) {
                    log(`‚ö†Ô∏è Heartbeat delayed by ${timeSinceLastHeartbeat}ms`, 'warning');
                    document.getElementById('blockingIndicator').style.display = 'block';
                } else {
                    document.getElementById('blockingIndicator').style.display = 'none';
                }
                
                lastHeartbeat = now;
                log('üíì Heartbeat');
            }, 100);
        }

        function startPerformanceMonitoring() {
            performanceInterval = setInterval(() => {
                const memory = performance.memory;
                if (memory) {
                    addPerformanceEntry(`Memory: Used ${Math.round(memory.usedJSHeapSize / 1024 / 1024)}MB, Total ${Math.round(memory.totalJSHeapSize / 1024 / 1024)}MB`);
                }
                
                addPerformanceEntry(`DOM elements: ${document.querySelectorAll('*').length}`);
                addPerformanceEntry(`Active timers: ${performance.getEntriesByType('measure').length}`);
            }, 2000);
        }

        async function testMainAppExecution() {
            log('üîç Testing main app execution with timeout...');
            
            const startTime = Date.now();
            
            try {
                // Set a timeout for the main app execution
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Execution timeout after 5 seconds')), 5000);
                });
                
                const executionPromise = (async () => {
                    const response = await fetch('http://localhost:8080/src/main.tsx');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const mainAppCode = await response.text();
                    log('‚úÖ Main app code loaded');
                    
                    // Try to execute with a timeout
                    return new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.type = 'module';
                        script.textContent = `
                            console.log('üöÄ Executing main app with timeout...');
                            try {
                                ${mainAppCode}
                                console.log('‚úÖ Main app execution completed');
                            } catch (error) {
                                console.error('‚ùå Main app execution error:', error);
                            }
                        `;
                        
                        document.head.appendChild(script);
                        resolve('Script executed');
                    });
                })();
                
                await Promise.race([executionPromise, timeoutPromise]);
                
                const endTime = Date.now();
                log(`‚úÖ Main app execution completed in ${endTime - startTime}ms`);
                
            } catch (error) {
                const endTime = Date.now();
                log(`‚ùå Main app execution failed after ${endTime - startTime}ms: ${error.message}`, 'error');
            }
        }

        function testInfiniteLoop() {
            log('üîç Testing infinite loop detection...');
            
            const startTime = Date.now();
            let iterations = 0;
            
            // Simulate a potentially infinite loop
            const testLoop = () => {
                iterations++;
                
                if (iterations > 1000) {
                    log(`‚ö†Ô∏è Loop detected: ${iterations} iterations`, 'warning');
                    return;
                }
                
                if (Date.now() - startTime > 1000) {
                    log(`‚ö†Ô∏è Loop timeout after ${iterations} iterations`, 'warning');
                    return;
                }
                
                // Use setTimeout to prevent blocking
                setTimeout(testLoop, 0);
            };
            
            testLoop();
        }

        function testBlockingCode() {
            log('üîç Testing blocking code detection...');
            
            const startTime = Date.now();
            
            // Simulate blocking code
            setTimeout(() => {
                log('üß™ Simulating blocking code...');
                
                // This will block the main thread
                const blockingStart = Date.now();
                while (Date.now() - blockingStart < 500) {
                    // Block for 500ms
                }
                
                const blockingEnd = Date.now();
                log(`‚ö†Ô∏è Blocking code executed for ${blockingEnd - blockingStart}ms`, 'warning');
                
            }, 1000);
        }

        function enableDevBypass() {
            localStorage.setItem('dev-bypass-auth', 'true');
            log('‚úÖ Dev bypass enabled');
        }

        // Initialize
        log('üöÄ Blocking code detector loaded');
        log('üíì Starting heartbeat monitoring');
        log('üìä Starting performance monitoring');
        
        startHeartbeat();
        startPerformanceMonitoring();
        
        // Test basic functionality
        setTimeout(() => {
            log('‚úÖ Basic functionality test passed');
        }, 1000);
    </script>
</body>
</html>
