<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Flow Debugger</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .error { background: #ffebee; border-color: #f44336; }
        .warning { background: #fff3e0; border-color: #ff9800; }
        .success { background: #e8f5e8; border-color: #4caf50; }
        .info { background: #e3f2fd; border-color: #2196f3; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .status { display: inline-block; padding: 4px 8px; border-radius: 3px; font-size: 12px; font-weight: bold; }
        .status.ok { background: #4caf50; color: white; }
        .status.error { background: #f44336; color: white; }
        .status.warning { background: #ff9800; color: white; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #2196f3; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-success { background: #4caf50; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Authentication Flow Debugger</h1>
        <p>This tool will help diagnose authentication issues in your CRM application.</p>
        
        <div class="section">
            <h2>1. JWT Token Analysis</h2>
            <button class="btn-primary" onclick="analyzeJWT()">Analyze JWT Tokens</button>
            <div id="jwt-results"></div>
        </div>

        <div class="section">
            <h2>2. Local Storage Analysis</h2>
            <button class="btn-primary" onclick="analyzeStorage()">Analyze Storage</button>
            <div id="storage-results"></div>
        </div>

        <div class="section">
            <h2>3. Supabase Client Configuration</h2>
            <button class="btn-primary" onclick="analyzeSupabaseConfig()">Check Supabase Config</button>
            <div id="supabase-results"></div>
        </div>

        <div class="section">
            <h2>4. API Request Headers Test</h2>
            <button class="btn-primary" onclick="testAPIHeaders()">Test API Headers</button>
            <div id="api-results"></div>
        </div>

        <div class="section">
            <h2>5. User Role & Permissions Check</h2>
            <button class="btn-primary" onclick="checkUserRoles()">Check User Roles</button>
            <div id="roles-results"></div>
        </div>

        <div class="section">
            <h2>6. Session State Analysis</h2>
            <button class="btn-primary" onclick="analyzeSessionState()">Analyze Session State</button>
            <div id="session-results"></div>
        </div>

        <div class="section">
            <h2>7. Clear Authentication State</h2>
            <button class="btn-danger" onclick="clearAuthState()">Clear All Auth Data</button>
            <div id="clear-results"></div>
        </div>

        <div class="section">
            <h2>8. Run All Tests</h2>
            <button class="btn-success" onclick="runAllTests()">Run Complete Analysis</button>
            <div id="all-results"></div>
        </div>
    </div>

    <script>
        // JWT Token Analysis
        function analyzeJWT() {
            const results = document.getElementById('jwt-results');
            results.innerHTML = '<h3>JWT Token Analysis</h3>';
            
            try {
                // Check for Supabase auth tokens in localStorage
                const authKeys = Object.keys(localStorage).filter(key => 
                    key.includes('supabase') || key.includes('auth') || key.includes('token')
                );
                
                let html = '<h4>Found Auth Keys in localStorage:</h4><ul>';
                authKeys.forEach(key => {
                    const value = localStorage.getItem(key);
                    html += `<li><strong>${key}:</strong> ${value ? value.substring(0, 100) + '...' : 'null'}</li>`;
                });
                html += '</ul>';
                
                // Check for JWT tokens and decode them
                const jwtTokens = authKeys.filter(key => {
                    const value = localStorage.getItem(key);
                    return value && value.includes('.');
                });
                
                html += '<h4>JWT Token Analysis:</h4>';
                jwtTokens.forEach(key => {
                    const token = localStorage.getItem(key);
                    try {
                        const parts = token.split('.');
                        if (parts.length === 3) {
                            const header = JSON.parse(atob(parts[0]));
                            const payload = JSON.parse(atob(parts[1]));
                            const now = Math.floor(Date.now() / 1000);
                            
                            html += `<div class="section info">
                                <h5>Token: ${key}</h5>
                                <p><strong>Header:</strong> <pre>${JSON.stringify(header, null, 2)}</pre></p>
                                <p><strong>Payload:</strong> <pre>${JSON.stringify(payload, null, 2)}</pre></p>
                                <p><strong>Expires:</strong> ${new Date(payload.exp * 1000).toLocaleString()}</p>
                                <p><strong>Status:</strong> <span class="status ${payload.exp > now ? 'ok' : 'error'}">${payload.exp > now ? 'Valid' : 'Expired'}</span></p>
                            </div>`;
                        }
                    } catch (e) {
                        html += `<p>Error decoding token ${key}: ${e.message}</p>`;
                    }
                });
                
                results.innerHTML += html;
            } catch (error) {
                results.innerHTML += `<div class="section error"><p>Error analyzing JWT tokens: ${error.message}</p></div>`;
            }
        }

        // Local Storage Analysis
        function analyzeStorage() {
            const results = document.getElementById('storage-results');
            results.innerHTML = '<h3>Local Storage Analysis</h3>';
            
            try {
                const allKeys = Object.keys(localStorage);
                const authKeys = allKeys.filter(key => 
                    key.includes('supabase') || key.includes('auth') || key.includes('token') || key.includes('user')
                );
                
                let html = '<h4>All localStorage Keys:</h4><ul>';
                allKeys.forEach(key => {
                    const value = localStorage.getItem(key);
                    const isAuth = authKeys.includes(key);
                    html += `<li class="${isAuth ? 'warning' : ''}">
                        <strong>${key}:</strong> ${value ? value.substring(0, 50) + '...' : 'null'}
                        ${isAuth ? ' <span class="status warning">AUTH</span>' : ''}
                    </li>`;
                });
                html += '</ul>';
                
                html += '<h4>Session Storage:</h4><ul>';
                const sessionKeys = Object.keys(sessionStorage);
                sessionKeys.forEach(key => {
                    const value = sessionStorage.getItem(key);
                    html += `<li><strong>${key}:</strong> ${value ? value.substring(0, 50) + '...' : 'null'}</li>`;
                });
                html += '</ul>';
                
                results.innerHTML += html;
            } catch (error) {
                results.innerHTML += `<div class="section error"><p>Error analyzing storage: ${error.message}</p></div>`;
            }
        }

        // Supabase Configuration Analysis
        function analyzeSupabaseConfig() {
            const results = document.getElementById('supabase-results');
            results.innerHTML = '<h3>Supabase Configuration Analysis</h3>';
            
            try {
                // Check if Supabase client is available
                if (typeof window.supabase !== 'undefined') {
                    results.innerHTML += '<div class="section success"><p>‚úÖ Supabase client is available</p></div>';
                    
                    // Check auth state
                    window.supabase.auth.getSession().then(({ data: { session }, error }) => {
                        if (error) {
                            results.innerHTML += `<div class="section error"><p>‚ùå Error getting session: ${error.message}</p></div>`;
                        } else if (session) {
                            results.innerHTML += `<div class="section success">
                                <p>‚úÖ User is authenticated</p>
                                <pre>${JSON.stringify(session, null, 2)}</pre>
                            </div>`;
                        } else {
                            results.innerHTML += '<div class="section warning"><p>‚ö†Ô∏è No active session</p></div>';
                        }
                    });
                } else {
                    results.innerHTML += '<div class="section error"><p>‚ùå Supabase client not available</p></div>';
                }
                
                // Check environment variables
                const envVars = {
                    'VITE_SUPABASE_URL': import.meta?.env?.VITE_SUPABASE_URL || 'Not set',
                    'VITE_SUPABASE_ANON_KEY': import.meta?.env?.VITE_SUPABASE_ANON_KEY ? 'Set' : 'Not set',
                    'VITE_SUPABASE_SERVICE_ROLE_KEY': import.meta?.env?.VITE_SUPABASE_SERVICE_ROLE_KEY ? 'Set' : 'Not set'
                };
                
                let html = '<h4>Environment Variables:</h4><ul>';
                Object.entries(envVars).forEach(([key, value]) => {
                    html += `<li><strong>${key}:</strong> ${value}</li>`;
                });
                html += '</ul>';
                
                results.innerHTML += html;
            } catch (error) {
                results.innerHTML += `<div class="section error"><p>Error analyzing Supabase config: ${error.message}</p></div>`;
            }
        }

        // API Headers Test
        function testAPIHeaders() {
            const results = document.getElementById('api-results');
            results.innerHTML = '<h3>API Headers Test</h3>';
            
            try {
                // Test a simple API call to check headers
                fetch('/api/test', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('sb-jedfundfhzytpnbjkspn-auth-token') || 'no-token'}`
                    }
                })
                .then(response => {
                    results.innerHTML += `<div class="section ${response.ok ? 'success' : 'error'}">
                        <p>API Test Response: ${response.status} ${response.statusText}</p>
                        <p>Headers sent: Authorization: Bearer ${localStorage.getItem('sb-jedfundfhzytpnbjkspn-auth-token') ? 'Present' : 'Missing'}</p>
                    </div>`;
                })
                .catch(error => {
                    results.innerHTML += `<div class="section warning">
                        <p>API Test failed (expected for test endpoint): ${error.message}</p>
                        <p>This is normal if the test endpoint doesn't exist</p>
                    </div>`;
                });
            } catch (error) {
                results.innerHTML += `<div class="section error"><p>Error testing API headers: ${error.message}</p></div>`;
            }
        }

        // User Roles Check
        function checkUserRoles() {
            const results = document.getElementById('roles-results');
            results.innerHTML = '<h3>User Roles & Permissions Check</h3>';
            
            try {
                // Check for user profile in localStorage
                const userProfile = localStorage.getItem('user_profile');
                if (userProfile) {
                    const profile = JSON.parse(userProfile);
                    results.innerHTML += `<div class="section success">
                        <h4>User Profile Found:</h4>
                        <pre>${JSON.stringify(profile, null, 2)}</pre>
                    </div>`;
                } else {
                    results.innerHTML += '<div class="section warning"><p>‚ö†Ô∏è No user profile found in localStorage</p></div>';
                }
                
                // Check for role-related data
                const roleKeys = Object.keys(localStorage).filter(key => 
                    key.includes('role') || key.includes('permission') || key.includes('owner')
                );
                
                if (roleKeys.length > 0) {
                    let html = '<h4>Role-related data found:</h4><ul>';
                    roleKeys.forEach(key => {
                        const value = localStorage.getItem(key);
                        html += `<li><strong>${key}:</strong> ${value}</li>`;
                    });
                    html += '</ul>';
                    results.innerHTML += html;
                } else {
                    results.innerHTML += '<div class="section info"><p>‚ÑπÔ∏è No role-related data found in localStorage</p></div>';
                }
            } catch (error) {
                results.innerHTML += `<div class="section error"><p>Error checking user roles: ${error.message}</p></div>`;
            }
        }

        // Session State Analysis
        function analyzeSessionState() {
            const results = document.getElementById('session-results');
            results.innerHTML = '<h3>Session State Analysis</h3>';
            
            try {
                // Check current URL for auth parameters
                const url = new URL(window.location.href);
                const authParams = ['code', 'state', 'error', 'error_description', 'access_token', 'refresh_token'];
                const foundParams = authParams.filter(param => url.searchParams.has(param));
                
                if (foundParams.length > 0) {
                    let html = '<h4>Auth parameters in URL:</h4><ul>';
                    foundParams.forEach(param => {
                        html += `<li><strong>${param}:</strong> ${url.searchParams.get(param)}</li>`;
                    });
                    html += '</ul>';
                    results.innerHTML += html;
                } else {
                    results.innerHTML += '<div class="section info"><p>‚ÑπÔ∏è No auth parameters in URL</p></div>';
                }
                
                // Check for auth state in memory
                if (typeof window.authState !== 'undefined') {
                    results.innerHTML += `<div class="section success">
                        <h4>Auth State in Memory:</h4>
                        <pre>${JSON.stringify(window.authState, null, 2)}</pre>
                    </div>`;
                } else {
                    results.innerHTML += '<div class="section warning"><p>‚ö†Ô∏è No auth state found in memory</p></div>';
                }
            } catch (error) {
                results.innerHTML += `<div class="section error"><p>Error analyzing session state: ${error.message}</p></div>`;
            }
        }

        // Clear Authentication State
        function clearAuthState() {
            const results = document.getElementById('clear-results');
            results.innerHTML = '<h3>Clearing Authentication State</h3>';
            
            try {
                // Clear localStorage auth items
                const authKeys = Object.keys(localStorage).filter(key => 
                    key.includes('supabase') || key.includes('auth') || key.includes('token') || key.includes('user')
                );
                
                authKeys.forEach(key => {
                    localStorage.removeItem(key);
                });
                
                // Clear sessionStorage
                sessionStorage.clear();
                
                results.innerHTML += `<div class="section success">
                    <p>‚úÖ Cleared ${authKeys.length} items from localStorage</p>
                    <p>‚úÖ Cleared sessionStorage</p>
                    <p>üîÑ Please refresh the page to see the changes</p>
                </div>`;
            } catch (error) {
                results.innerHTML += `<div class="section error"><p>Error clearing auth state: ${error.message}</p></div>`;
            }
        }

        // Run All Tests
        function runAllTests() {
            const results = document.getElementById('all-results');
            results.innerHTML = '<h3>Running Complete Authentication Analysis</h3>';
            
            // Run all tests in sequence
            setTimeout(() => analyzeJWT(), 100);
            setTimeout(() => analyzeStorage(), 200);
            setTimeout(() => analyzeSupabaseConfig(), 300);
            setTimeout(() => testAPIHeaders(), 400);
            setTimeout(() => checkUserRoles(), 500);
            setTimeout(() => analyzeSessionState(), 600);
            
            results.innerHTML += '<div class="section info"><p>üîÑ Running all tests... Check individual sections above for results.</p></div>';
        }

        // Auto-run on page load
        window.addEventListener('load', () => {
            console.log('Authentication Debugger loaded');
        });
    </script>
</body>
</html>
