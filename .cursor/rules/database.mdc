---
description: Database patterns, Supabase usage, and RLS security
globs:
  [
    '**/services/**',
    '**/utils/databaseQueries.ts',
    '**/integrations/supabase/**',
  ]
alwaysApply: false
---

# Database Best Practices

## Supabase MCP Access

For any database-related issues, queries, migrations, or operations, you have access to **Supabase MCP (Model Context Protocol)** tools. Use these tools when:

- Inspecting database schema, tables, or columns
- Executing SQL queries or migrations
- Checking RLS policies and security advisors
- Viewing database logs
- Managing projects, branches, or migrations
- Generating TypeScript types from schema

**Always use Supabase MCP tools for database operations** instead of making assumptions about schema or structure.

## Key Tables

- **leads** - Event-captured leads with OCR data (status: processing | active | replied_manual, quality_rank: hot | warm | cold)
- **workflows** - Email automation workflows (email_provider: lemlist | gmail)
- **companies** - Company profiles with enrichment data
- **shows** - Exhibition/event tracking (status: upcoming | live | ended)
- **activity_log** - Activity tracking for leads
- **email_sends** - Email send tracking
- **email_replies** - Reply analysis and sentiment tracking
- **email_threads** - Gmail conversation threads
- **email_messages** - Individual email messages
- **user_profiles** - User accounts
- **user_settings** - User preferences and settings

## Database Access Patterns

```typescript
// ✅ CORRECT: Use type-safe queries
import { DatabaseQueries } from '@/utils/databaseQueries';
const lead = await DatabaseQueries.getEntity<Lead>('leads', id);

// ✅ CORRECT: Use service functions
import { getLeads } from '@/services/leadsService';
const leads = await getLeads({ status: 'active', quality_rank: 'hot' });

// ❌ INCORRECT: Don't bypass type system
const { data } = await supabase.from('leads').select('*').eq('id', id);
```

## Supabase Client Usage

```typescript
// Import the Supabase client
import { supabase } from '@/integrations/supabase/client';

// ✅ CORRECT: Always use service functions
import { getLeads } from '@/services/leadsService';

// ✅ CORRECT: Type-safe queries with proper selection
const { data, error } = await supabase
  .from('leads')
  .select('id, first_name, last_name, email, status, quality_rank')
  .eq('status', 'active')
  .eq('quality_rank', 'hot');

// ❌ INCORRECT: Selecting all columns
const { data } = await supabase.from('leads').select('*');

// ❌ INCORRECT: Not handling errors
const { data } = await supabase.from('leads').select('*');
setLeads(data); // data could be null!
```

## RLS (Row Level Security)

- RLS is **always enabled** on Supabase tables
- Users can only access data they own (via `user_id` for leads, `owner_id` for shows)
- Never bypass RLS - it's a security feature
- Test with different users to ensure proper access control

## Lead Status & Quality

### Lead Status (leads table)
- **processing** - OCR scan being processed
- **active** - Lead is active and ready for outreach
- **replied_manual** - Lead has manually replied

### Quality Rank (leads table)
- **hot** - High-quality lead
- **warm** - Medium-quality lead
- **cold** - Low-quality lead

## Database Commands

```bash
npm run db:schema              # Show all tables
npm run db:schema leads        # Show leads table fields
npm run db:schema companies name  # Show specific field
```

## Status Utilities

- Use `src/utils/statusUtils.ts` for consistent status display
- Use `getStatusDisplayText()` for UI display
- Use `normalizeStatus()` for backend normalization
