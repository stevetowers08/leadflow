# Product Requirements Document: HubSpot & Mailchimp Integrations

**Version:** 1.1  
**Last Updated:** October 30, 2025  
**Status:** Partially Implemented  
**Implementation by:** Cursor AI Assistant

---

## 1. Executive Summary

This PRD outlines the technical requirements for implementing HubSpot and Mailchimp API integrations into the application. Both integrations will enable bidirectional data synchronization, contact management, and marketing automation capabilities.

---

## 2. Integration Overview

### 2.1 HubSpot Integration

- **API Version:** v3 (current stable)
- **API Type:** RESTful
- **Base URL:** `https://api.hubapi.com`
- **Documentation:** https://developers.hubspot.com/docs/api-reference/overview

### 2.2 Mailchimp Integration

- **API Version:** Marketing API v3.0
- **API Type:** RESTful
- **Base URL:** `https://{dc}.api.mailchimp.com/3.0/`
- **Documentation:** https://mailchimp.com/developer/marketing/api/

---

## 3. Authentication Requirements

### 3.1 HubSpot Authentication

**Recommended: OAuth 2.0** (for production/multi-user apps)

```javascript
// OAuth Flow Configuration
const HUBSPOT_CONFIG = {
  client_id: process.env.HUBSPOT_CLIENT_ID,
  client_secret: process.env.HUBSPOT_CLIENT_SECRET,
  redirect_uri: process.env.HUBSPOT_REDIRECT_URI,
  scopes: [
    'crm.objects.contacts.read',
    'crm.objects.contacts.write',
    'crm.objects.companies.read',
    'crm.objects.companies.write',
    'crm.objects.deals.read',
    'crm.objects.deals.write',
  ],
};

// Authorization URL
const authUrl = `https://app.hubspot.com/oauth/authorize?client_id=${client_id}&redirect_uri=${redirect_uri}&scope=${scopes}`;
```

**Alternative: Private App Access Token** (for single account/internal use)

- Navigate to Settings â†’ Integrations â†’ Private Apps
- Create private app with required scopes
- Use access token in Authorization header: `Authorization: Bearer YOUR_ACCESS_TOKEN`

### 3.2 Mailchimp Authentication

**Recommended: OAuth 2.0** (for production/multi-user apps)

```javascript
// OAuth Flow Configuration
const MAILCHIMP_CONFIG = {
  client_id: process.env.MAILCHIMP_CLIENT_ID,
  client_secret: process.env.MAILCHIMP_CLIENT_SECRET,
  redirect_uri: process.env.MAILCHIMP_REDIRECT_URI,
};

// Authorization URL
const authUrl = `https://login.mailchimp.com/oauth2/authorize?response_type=code&client_id=${client_id}&redirect_uri=${redirect_uri}`;
```

**Alternative: API Key** (for development/single account)

- Navigate to Account â†’ Extras â†’ API Keys
- Generate new API key
- Extract data center from account URL (e.g., `us19` from `https://us19.admin.mailchimp.com/`)
- Use Basic Auth: `Authorization: Basic base64('anystring:API_KEY')`

---

## 4. Core Functionality Requirements

### 4.1 HubSpot Core Features

#### 4.1.1 Contact Management

```javascript
// Create Contact
POST /crm/v3/objects/contacts
{
  "properties": {
    "email": "contact@example.com",
    "firstname": "John",
    "lastname": "Doe",
    "phone": "+1234567890",
    "company": "Example Corp"
  }
}

// Get Contact by Email
GET /crm/v3/objects/contacts/{contactId}?properties=email,firstname,lastname

// Update Contact
PATCH /crm/v3/objects/contacts/{contactId}
{
  "properties": {
    "phone": "+0987654321"
  }
}

// Search Contacts
POST /crm/v3/objects/contacts/search
{
  "filterGroups": [{
    "filters": [{
      "propertyName": "email",
      "operator": "EQ",
      "value": "contact@example.com"
    }]
  }]
}
```

#### 4.1.2 Company Management

```javascript
// Create Company
POST /crm/v3/objects/companies
{
  "properties": {
    "name": "Example Corp",
    "domain": "example.com",
    "city": "Sydney",
    "industry": "Technology"
  }
}
```

#### 4.1.3 Deal Management

```javascript
// Create Deal
POST /crm/v3/objects/deals
{
  "properties": {
    "dealname": "New Deal",
    "amount": "10000",
    "dealstage": "qualifiedtobuy",
    "pipeline": "default"
  }
}
```

#### 4.1.4 Associations

```javascript
// Associate Contact with Company
PUT /
  crm /
  v4 /
  objects /
  contact /
  { contactId } /
  associations /
  company /
  { companyId }[
    {
      associationCategory: 'HUBSPOT_DEFINED',
      associationTypeId: 279, // Contact to Company
    }
  ];
```

### 4.2 Mailchimp Core Features

#### 4.2.1 Audience Management

```javascript
// Get Audiences
GET /lists

// Create Audience Member
POST /lists/{list_id}/members
{
  "email_address": "subscriber@example.com",
  "status": "subscribed",
  "merge_fields": {
    "FNAME": "John",
    "LNAME": "Doe"
  },
  "tags": ["customer", "vip"]
}

// Update Audience Member
PATCH /lists/{list_id}/members/{subscriber_hash}
{
  "merge_fields": {
    "FNAME": "Jane"
  }
}

// Get Member by Email
GET /lists/{list_id}/members/{subscriber_hash}
// subscriber_hash = MD5 hash of lowercase email
```

#### 4.2.2 Campaign Management

```javascript
// Create Campaign
POST /campaigns
{
  "type": "regular",
  "recipients": {
    "list_id": "list123"
  },
  "settings": {
    "subject_line": "Your Subject",
    "from_name": "Your Company",
    "reply_to": "reply@example.com"
  }
}

// Get Campaign Stats
GET /reports/{campaign_id}
```

#### 4.2.3 Tags Management

```javascript
// Add Tags to Member
POST /lists/{list_id}/members/{subscriber_hash}/tags
{
  "tags": [
    {"name": "new-customer", "status": "active"},
    {"name": "vip", "status": "active"}
  ]
}
```

---

## 5. Implementation Architecture

### 5.1 Backend Structure

```
/src
  /integrations
    /hubspot
      - client.js          # HubSpot API client
      - auth.js            # OAuth/token management
      - contacts.js        # Contact operations
      - companies.js       # Company operations
      - deals.js           # Deal operations
      - webhooks.js        # Webhook handlers
    /mailchimp
      - client.js          # Mailchimp API client
      - auth.js            # OAuth/token management
      - audiences.js       # Audience operations
      - campaigns.js       # Campaign operations
      - webhooks.js        # Webhook handlers
    /shared
      - errorHandler.js    # Common error handling
      - rateLimiter.js     # Rate limit management
      - dataMapper.js      # Data transformation
```

### 5.2 Database Schema

```sql
-- HubSpot Integration
CREATE TABLE hubspot_connections (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  access_token TEXT ENCRYPTED,
  refresh_token TEXT ENCRYPTED,
  expires_at TIMESTAMP,
  portal_id VARCHAR(255),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE hubspot_sync_logs (
  id UUID PRIMARY KEY,
  connection_id UUID REFERENCES hubspot_connections(id),
  sync_type VARCHAR(50), -- 'contact', 'company', 'deal'
  direction VARCHAR(10), -- 'inbound', 'outbound'
  status VARCHAR(20),
  records_processed INTEGER,
  error_message TEXT,
  synced_at TIMESTAMP DEFAULT NOW()
);

-- Mailchimp Integration
CREATE TABLE mailchimp_connections (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  access_token TEXT ENCRYPTED,
  data_center VARCHAR(10),
  list_id VARCHAR(255),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE mailchimp_sync_logs (
  id UUID PRIMARY KEY,
  connection_id UUID REFERENCES mailchimp_connections(id),
  sync_type VARCHAR(50), -- 'subscriber', 'campaign'
  direction VARCHAR(10),
  status VARCHAR(20),
  records_processed INTEGER,
  error_message TEXT,
  synced_at TIMESTAMP DEFAULT NOW()
);
```

---

## 6. Rate Limits & Best Practices

### 6.1 HubSpot Rate Limits

- **Default:** 100 requests per 10 seconds (burst)
- **Daily:** Varies by subscription tier
- **Strategy:** Implement exponential backoff on 429 errors
- **Batch Operations:** Use batch endpoints for bulk operations (max 100 records)

```javascript
const HUBSPOT_RATE_LIMIT = {
  requests: 100,
  window: 10000, // 10 seconds
  retryAfter: 1000, // Initial retry delay
  maxRetries: 3,
};
```

### 6.2 Mailchimp Rate Limits

- **Concurrent:** 10 simultaneous connections per user
- **Timeout:** 120 seconds per request
- **Strategy:** Use batch endpoint for long-running operations
- **Caching:** Cache frequently accessed data (audiences, lists)

```javascript
const MAILCHIMP_RATE_LIMIT = {
  maxConcurrent: 10,
  timeout: 120000, // 120 seconds
  retryAfter: 2000,
  maxRetries: 3,
};
```

---

## 7. Webhooks Implementation

### 7.1 HubSpot Webhooks

```javascript
// Webhook Subscription
POST /webhooks/v3/{appId}/subscriptions
{
  "eventType": "contact.propertyChange",
  "propertyName": "email",
  "active": true
}

// Webhook Endpoint Handler
app.post('/webhooks/hubspot', async (req, res) => {
  const { objectId, eventType, propertyName, propertyValue } = req.body;

  // Verify request from HubSpot
  const signature = req.headers['x-hubspot-signature-v3'];
  if (!verifyHubSpotSignature(req.body, signature)) {
    return res.status(401).send('Unauthorized');
  }

  // Process event
  await processHubSpotEvent(eventType, req.body);

  res.status(200).send('OK');
});
```

### 7.2 Mailchimp Webhooks

```javascript
// Webhook Configuration (via UI or API)
POST /lists/{list_id}/webhooks
{
  "url": "https://yourapp.com/webhooks/mailchimp",
  "events": {
    "subscribe": true,
    "unsubscribe": true,
    "profile": true,
    "cleaned": true,
    "upemail": true,
    "campaign": true
  },
  "sources": {
    "user": true,
    "admin": true,
    "api": true
  }
}

// Webhook Endpoint Handler
app.post('/webhooks/mailchimp', async (req, res) => {
  const { type, data } = req.body;

  // Handle different event types
  switch(type) {
    case 'subscribe':
      await handleNewSubscriber(data);
      break;
    case 'unsubscribe':
      await handleUnsubscribe(data);
      break;
    case 'profile':
      await handleProfileUpdate(data);
      break;
  }

  res.status(200).send('OK');
});
```

---

## 8. Error Handling

### 8.1 Common Error Scenarios

```javascript
class IntegrationError extends Error {
  constructor(message, code, details) {
    super(message);
    this.code = code;
    this.details = details;
  }
}

const errorHandler = {
  // HubSpot Errors
  handleHubSpotError(error) {
    if (error.response?.status === 401) {
      throw new IntegrationError(
        'Invalid or expired token',
        'AUTH_ERROR',
        error
      );
    }
    if (error.response?.status === 429) {
      throw new IntegrationError('Rate limit exceeded', 'RATE_LIMIT', error);
    }
    if (error.response?.status === 400) {
      throw new IntegrationError(
        'Invalid request data',
        'VALIDATION_ERROR',
        error
      );
    }
  },

  // Mailchimp Errors
  handleMailchimpError(error) {
    if (error.response?.status === 401) {
      throw new IntegrationError('Invalid API key', 'AUTH_ERROR', error);
    }
    if (error.response?.status === 429) {
      throw new IntegrationError('Too many requests', 'RATE_LIMIT', error);
    }
    if (error.response?.body?.title === 'Member Exists') {
      throw new IntegrationError(
        'Subscriber already exists',
        'DUPLICATE',
        error
      );
    }
  },
};
```

---

## 9. Data Synchronization Strategy

### 9.1 Sync Patterns

**Option A: Real-time Webhook Sync**

- Event-driven updates via webhooks
- Low latency, immediate consistency
- Requires webhook endpoint setup

**Option B: Scheduled Batch Sync**

- Periodic sync jobs (hourly/daily)
- Better for large data volumes
- Reduces API calls

**Option C: Hybrid Approach** (Recommended)

- Webhooks for critical updates (new contacts, deals)
- Batch sync for historical data and reconciliation
- Best balance of real-time and efficiency

### 9.2 Data Mapping Example

```javascript
// Map internal contact to HubSpot contact
function mapToHubSpotContact(internalContact) {
  return {
    properties: {
      email: internalContact.email,
      firstname: internalContact.firstName,
      lastname: internalContact.lastName,
      phone: internalContact.phone,
      company: internalContact.companyName,
      custom_field: internalContact.customData,
    },
  };
}

// Map internal contact to Mailchimp subscriber
function mapToMailchimpSubscriber(internalContact) {
  return {
    email_address: internalContact.email,
    status: internalContact.isSubscribed ? 'subscribed' : 'unsubscribed',
    merge_fields: {
      FNAME: internalContact.firstName,
      LNAME: internalContact.lastName,
      PHONE: internalContact.phone,
    },
    tags: internalContact.tags || [],
  };
}
```

---

## 10. Testing Requirements

### 10.1 Unit Tests

- Authentication flow (OAuth & API keys)
- CRUD operations for each entity
- Error handling scenarios
- Rate limit handling
- Data transformation functions

### 10.2 Integration Tests

- End-to-end OAuth flow
- Webhook event processing
- Batch synchronization
- Conflict resolution

### 10.3 Test Accounts

- **HubSpot:** Create developer account at https://developers.hubspot.com
- **Mailchimp:** Create test account at https://mailchimp.com/signup

---

## 11. Security Considerations

1. **Token Storage:** Encrypt all access/refresh tokens in database
2. **Environment Variables:** Never commit API credentials to version control
3. **Webhook Security:** Validate webhook signatures
4. **HTTPS Only:** All API calls must use HTTPS
5. **Scoped Permissions:** Request minimum required scopes
6. **Token Refresh:** Implement automatic token refresh before expiry
7. **Audit Logging:** Log all integration activities

```javascript
// Example: Secure token storage
const crypto = require('crypto');

function encryptToken(token) {
  const algorithm = 'aes-256-gcm';
  const key = process.env.ENCRYPTION_KEY;
  const iv = crypto.randomBytes(16);
  const cipher = crypto.createCipheriv(algorithm, key, iv);

  let encrypted = cipher.update(token, 'utf8', 'hex');
  encrypted += cipher.final('hex');

  return {
    encrypted,
    iv: iv.toString('hex'),
    tag: cipher.getAuthTag().toString('hex'),
  };
}
```

---

## 12. Implementation Status

### âœ… Completed (October 30, 2025)

#### Phase 1: Setup

- âœ… Created database schema (migration: `20251030000001_create_hubspot_and_mailchimp_integrations.sql`)
- âœ… Set up integration tables with RLS policies
- âœ… Added environment variable configuration to `env.example`

#### Phase 2: Service Layer

- âœ… Created HubSpot API client (`src/services/hubspot/hubspotClient.ts`)
- âœ… Created HubSpot authentication service (`src/services/hubspot/hubspotAuthService.ts`)
- âœ… Created Mailchimp API client (`src/services/mailchimp/mailchimpClient.ts`)
- âœ… Created Mailchimp authentication service (`src/services/mailchimp/mailchimpAuthService.ts`)
- âœ… Implemented OAuth flow for HubSpot
- âœ… Implemented API key authentication for Mailchimp
- âœ… Added token refresh mechanism for HubSpot
- âœ… Browser-compatible authentication (using `btoa` instead of `Buffer`)

#### Phase 3: UI Components

- âœ… Created `HubSpotIntegrationCard` component
- âœ… Created `MailchimpIntegrationCard` component
- âœ… Integrated cards into `IntegrationsPage`
- âœ… Created OAuth callback handler page
- âœ… Added routes to `App.tsx`

### ðŸš§ Remaining Tasks

#### Phase 4: Core Features

- [ ] HubSpot contact synchronization
- [ ] HubSpot company synchronization
- [ ] HubSpot deal synchronization
- [ ] Mailchimp subscriber synchronization
- [ ] Data mapping functions
- [ ] Error handling middleware

#### Phase 5: Webhooks

- [ ] Set up webhook endpoints
- [ ] Implement HubSpot webhook handlers
- [ ] Implement Mailchimp webhook handlers
- [ ] Webhook signature verification

#### Phase 6: Sync Engine

- [ ] Build sync orchestration service
- [ ] Implement batch sync jobs
- [ ] Add conflict resolution
- [ ] Create sync dashboard UI

#### Phase 7: Testing & Deployment

- [ ] Write unit tests for services
- [ ] Integration testing
- [ ] Load testing for rate limits
- [ ] Production deployment

---

## 13. Monitoring & Maintenance

### 13.1 Metrics to Track

- API request success/failure rates
- Average response times
- Rate limit hit frequency
- Sync job completion times
- Webhook processing latency

### 13.2 Alerts

- Authentication failures
- Repeated rate limit errors
- Webhook endpoint downtime
- Sync job failures

---

## 14. Resources

### Official Documentation

- HubSpot: https://developers.hubspot.com/docs
- Mailchimp: https://mailchimp.com/developer/marketing/

### API References

- HubSpot API: https://developers.hubspot.com/docs/api-reference/overview
- Mailchimp API: https://mailchimp.com/developer/marketing/api/

### SDKs (Optional)

- HubSpot Node.js: `@hubspot/api-client`
- Mailchimp Node.js: `@mailchimp/mailchimp_marketing`

### Community

- HubSpot Community: https://community.hubspot.com/t5/APIs-Integrations/bd-p/integrations
- Mailchimp Developer: https://mailchimp.com/developer/

---

## 15. Cost Considerations

### HubSpot

- Free tier available for development
- Production costs vary by subscription tier
- API limits increase with paid plans

### Mailchimp

- Free tier: Up to 500 contacts, 1,000 emails/month
- Standard: $20/month for 500 contacts
- API access on all plans

---

**Prepared for:** Cursor AI Implementation  
**Technical Stack:** React/TypeScript with Supabase  
**Implementation Date:** October 30, 2025  
**Status:** Core infrastructure complete, sync engine pending

## 16. Implementation Notes

### Key Implementation Changes

1. **Browser Compatibility**: Replaced Node.js `Buffer` API with `btoa()` for Mailchimp Basic Auth to ensure browser compatibility.

2. **Database Schema**: Created comprehensive tables with:
   - Connection management (`hubspot_connections`, `mailchimp_connections`)
   - Sync logging (`hubspot_sync_logs`, `mailchimp_sync_logs`)
   - Data mapping (`hubspot_contact_mappings`, `hubspot_company_mappings`, `mailchimp_subscriber_mappings`)
   - Integration settings

3. **Authentication Patterns**:
   - **HubSpot**: OAuth 2.0 flow with automatic token refresh
   - **Mailchimp**: API key authentication with manual entry

4. **UI Components**: Three separate integration cards for:
   - Gmail (existing)
   - HubSpot (new)
   - Mailchimp (new)

### Next Steps

1. **Complete Sync Engine**: Implement bidirectional data synchronization
2. **Add Webhooks**: Set up real-time event handling
3. **Testing**: Comprehensive testing of all sync operations
4. **Documentation**: User-facing documentation for setup and usage
